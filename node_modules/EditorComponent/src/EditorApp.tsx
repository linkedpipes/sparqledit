import { MonacoEditorProvider } from './providers/MonacoEditorProvider';
import { ErrorMessageProvider } from './providers/ErrorMessageProvider';
import { PluginManagerFactory } from './plugins/PluginManagerFactory';
import { PluginManager } from './plugins/PluginManager';
import { EditorSettingsService } from './service/EditorSettingsService';
import { EditorSettingsStore } from './store/EditorSettingsStore';
import { EditorSettingsComponent } from "./components/EditorSettingsComponent"
import { MonacoEditorWrapper } from "./components/MonacoEditorWrapper"
import { ParsingService, ParserResult, ParserResultStore } from "./service/ParsingService";
import * as React from "react";
import { observer } from "mobx-react";
import DevTools from 'mobx-react-devtools';
import { observable } from "EditorComponent/node_modules/mobx/lib/mobx";
import { ParserLogger } from "./components/ParserLogger";
import RaisedButton from 'material-ui/RaisedButton';
import MuiThemeProvider from 'material-ui/styles/MuiThemeProvider';
import { ParserVisualiser } from "./components/ParserVisualiser";
import { ParserVisualisingService, IParserVisualisingServiceResult } from "./service/ParserVisualisingService"
import { ERSParserDebuggable } from "ERSParser";
import { ErrorConsole } from "./components/ErrorConsole";
import { ErrorCheckPlugin } from "./plugins/ErrorCheckPlugin/ErrorCheckPlugin";
import { ParserErrorStore } from "./store/ParserErrorsStore";
import { ToolRenderer } from "./components/ToolRenderer";
import { ToolStore, Tool } from "./store/ToolStore";
import { EditorPluginApi } from "./plugins/EditorPluginApi";
var injectTapEventPlugin = require("react-tap-event-plugin");

@observer
export class EditorApp extends React.Component<any, any> {
    private toolStore = new ToolStore();
    private editorSettingsService = new EditorSettingsService();
    private editorSettingsStore: EditorSettingsStore;
    private monacoEditor: monaco.editor.IStandaloneCodeEditor;
    private pluginManager: PluginManager;
    private errorMessageProvider: ErrorMessageProvider;
    private parserErrorStore: ParserErrorStore;

    constructor() {
        super();
        injectTapEventPlugin();
        this.editorSettingsStore = new EditorSettingsStore();
        this.init();
    }

    private init() {
        this.editorSettingsStore = this.editorSettingsService.createAndLoadSettingsFromCookies();
        var pluginManagerFactory = new PluginManagerFactory();
        this.pluginManager = pluginManagerFactory.createPluginManager();
        this.parserErrorStore = new ParserErrorStore();
        this.errorMessageProvider = new ErrorMessageProvider(this.parserErrorStore);
        // Hack how to inject message provider
        (this.pluginManager.plugins[2] as ErrorCheckPlugin).setErrorMessageProvider(this.errorMessageProvider);
    }

    setMonacoEditor(monacoEditor: monaco.editor.IStandaloneCodeEditor) {
        this.monacoEditor = monacoEditor;
        var editorPluginApi = new EditorPluginApi(
            this.editorSettingsStore,
            this.toolStore);
        this.pluginManager.initPlugins(monacoEditor, editorPluginApi);
        this.errorMessageProvider.init(monacoEditor);
    }

    getEditorContent() {
        return this.monacoEditor.getModel().getValue();
    }

    render() {
        return (<MuiThemeProvider>
            <ToolRenderer toolStore={this.toolStore}>
                <MonacoEditorWrapper setMonacoEditor={this.setMonacoEditor.bind(this)} />
                <ErrorConsole parserErrorStore={this.parserErrorStore} />
                <EditorSettingsComponent editorSettingsStore={this.editorSettingsStore} />
                <ParserVisualiser ediorSettingsStore={this.editorSettingsStore} />
                <DevTools />
            </ToolRenderer>
        </MuiThemeProvider >);
    }
}