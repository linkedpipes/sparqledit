var chai = require('chai');
var PreParser = require('../src/PreParser').PreParser;

function runPreParser(query) {
    var preParser = new PreParser();
    return preParser.run(query);
}

describe("PreParser should", function () {
    it("run with empty query", function () {
        var query = '';
        var result = runPreParser(query);
        chai.expect(result.haltingError).to.be.null;
        chai.expect(result.recoverableErrors.length).equal(0);
        chai.expect(result.fixedQuery).equal(query);
    });

    it("not report error when query is ok.", function () {
        var query = 'a{{hsf_/šěf{}dsfg}fdd{dgdffsdfga}}';
        var result = runPreParser(query);
        chai.expect(result.haltingError).to.be.null;
        chai.expect(result.recoverableErrors.length).equal(0);
        chai.expect(result.fixedQuery).equal(query);
    });

    it("correctly report mixed parenthesis errors.", function () {
        var query = 's{ff}g}ss}d{d{';
        var result = runPreParser(query);
        chai.expect(result.haltingError).to.be.null;
        chai.expect(result.recoverableErrors.length).equal(3);
        chai.expect(result.recoverableErrors[0].type).equal('extraClosedParenthesis');
        chai.expect(result.recoverableErrors[0].options.offset).equal(6);
        chai.expect(result.recoverableErrors[1].type).equal('extraClosedParenthesis');
        chai.expect(result.recoverableErrors[1].options.offset).equal(9);
        chai.expect(result.recoverableErrors[2].type).equal('missingOpenParenthesis');
        chai.expect(result.recoverableErrors[2].options.count).equal(2);
        chai.expect(result.fixedQuery).equal('s{ff}gssd{d{}}');
    });

    describe("find extra closed parenthesis", function () {
        it("test case 1", function () {
            var query = '}';
            var result = runPreParser(query);
            chai.expect(result.haltingError).to.be.null;
            chai.expect(result.recoverableErrors.length).equal(1);
            chai.expect(result.recoverableErrors[0].type).equal('extraClosedParenthesis');
            chai.expect(result.fixedQuery).equal('');
        });

        it("test case 2", function () {
            var query = '{{}}}';
            var result = runPreParser(query);
            chai.expect(result.haltingError).to.be.null;
            chai.expect(result.recoverableErrors.length).equal(1);
            chai.expect(result.recoverableErrors[0].type).equal('extraClosedParenthesis');
            chai.expect(result.fixedQuery).equal('{{}}');
        });

        it("test case 3", function () {
            var query = 'asdfsad{asdf}asdfasfd}';
            var result = runPreParser(query);
            chai.expect(result.haltingError).to.be.null;
            chai.expect(result.recoverableErrors.length).equal(1);
            chai.expect(result.recoverableErrors[0].type).equal('extraClosedParenthesis');
            chai.expect(result.fixedQuery).equal('asdfsad{asdf}asdfasfd');
        });

        it("test case 4", function () {
            var query = '{}}}{}}';
            var result = runPreParser(query);
            chai.expect(result.haltingError).to.be.null;
            chai.expect(result.recoverableErrors.length).equal(3);
            result.recoverableErrors.forEach(function (error) {
                chai.expect(error.type).equal('extraClosedParenthesis');
            });
            chai.expect(result.fixedQuery).equal('{}{}');
        });

        it("test case 4", function () {
            var query = '0123456}89}123';
            var result = runPreParser(query);
            chai.expect(result.haltingError).to.be.null;
            chai.expect(result.recoverableErrors.length).equal(2);
            chai.expect(result.recoverableErrors[0].type).equal('extraClosedParenthesis');
            chai.expect(result.recoverableErrors[0].options.offset).equal(7);
            chai.expect(result.recoverableErrors[1].type).equal('extraClosedParenthesis');
            chai.expect(result.recoverableErrors[1].options.offset).equal(10);
            chai.expect(result.fixedQuery).equal('012345689123');
        });
    });

    describe("find missing closed parenthesis", function () {
        it("test case 1", function () {
            var query = '{';
            var result = runPreParser(query);
            chai.expect(result.haltingError).to.be.null;
            chai.expect(result.recoverableErrors.length).equal(1);
            chai.expect(result.recoverableErrors[0].type).equal('missingOpenParenthesis');
            chai.expect(result.recoverableErrors[0].options.count).equal(1);
            chai.expect(result.fixedQuery).equal('{}');
        });

        it("test case 2", function () {
            var query = '{{}{{}}{{';
            var result = runPreParser(query);
            chai.expect(result.haltingError).to.be.null;
            chai.expect(result.recoverableErrors.length).equal(1);
            chai.expect(result.recoverableErrors[0].type).equal('missingOpenParenthesis');
            chai.expect(result.recoverableErrors[0].options.count).equal(3);
            chai.expect(result.fixedQuery).equal('{{}{{}}{{}}}');
        });

        it("test case 3", function () {
            var query = 'sdaf{asdf{a}d{g{h}hj}{r{e';
            var result = runPreParser(query);
            chai.expect(result.haltingError).to.be.null;
            chai.expect(result.recoverableErrors.length).equal(1);
            chai.expect(result.recoverableErrors[0].type).equal('missingOpenParenthesis');
            chai.expect(result.recoverableErrors[0].options.count).equal(3);
            chai.expect(result.fixedQuery).equal('sdaf{asdf{a}d{g{h}hj}{r{e}}}');
        });
    });
    
    describe("correctly work with single quotes", function () {
        it("test case 1", function () {
            var query = "d{d{d'dss{'d}}ddsd";
            var result = runPreParser(query);
            chai.expect(result.haltingError).to.be.null;
            chai.expect(result.recoverableErrors.length).equal(0);
        })

        it("test case 2", function () {
            var query = "{ssdas\\' { s'}";
            var result = runPreParser(query);
            chai.expect(result.haltingError).to.be.null;
            chai.expect(result.recoverableErrors.length).equal(0);
        })

        it("test case 3", function () {
            var query = "{'ssdas\\' \\\" \\s { s'}";
            var result = runPreParser(query);
            chai.expect(result.haltingError).to.be.null;
            chai.expect(result.recoverableErrors.length).equal(0);
        })

        it("test case 4", function () {
            var query = "{'ssda { }";
            var result = runPreParser(query);
            chai.expect(result.haltingError).to.be.not.null;
            chai.expect(result.haltingError.type).equal("missingCloseQuotes");
            chai.expect(result.haltingError.options.openQuotesCharacter).equal("'");
            chai.expect(result.recoverableErrors.length).equal(0);
        })

        it("test case 5", function () {
            var query = "{'ssda \\' { }";
            var result = runPreParser(query);
            chai.expect(result.haltingError).to.be.not.null;
            chai.expect(result.haltingError.type).equal("missingCloseQuotes");
            chai.expect(result.haltingError.options.openQuotesCharacter).equal("'");
            chai.expect(result.recoverableErrors.length).equal(0);
        })

        it("test case 6", function () {
            var query = "{'ssda \\";
            var result = runPreParser(query);
            chai.expect(result.haltingError).to.be.not.null;
            chai.expect(result.haltingError.type).equal("missingCloseQuotes");
            chai.expect(result.haltingError.options.openQuotesCharacter).equal("'");
            chai.expect(result.recoverableErrors.length).equal(0);
        })
    });

    describe("correctly work with double quotes", function () {
        it("test case 1", function () {
            var query = 'd{d{d"dss{"d}}ddsd';
            var result = runPreParser(query);
            chai.expect(result.haltingError).to.be.null;
            chai.expect(result.recoverableErrors.length).equal(0);
        })

        it("test case 2", function () {
            var query = '{"ssdas\\" { s"}';
            var result = runPreParser(query);
            chai.expect(result.haltingError).to.be.null;
            chai.expect(result.recoverableErrors.length).equal(0);
        })

        it("test case 3", function () {
            var query = '{"ssdas\\" \\\' \\s { s"}';
            var result = runPreParser(query);
            chai.expect(result.haltingError).to.be.null;
            chai.expect(result.recoverableErrors.length).equal(0);
        })

        it("test case 4", function () {
            var query = '{"ssda { }';
            var result = runPreParser(query);
            chai.expect(result.haltingError).to.be.not.null;
            chai.expect(result.haltingError.type).equal("missingCloseQuotes");
            chai.expect(result.haltingError.options.openQuotesCharacter).equal('"');
            chai.expect(result.recoverableErrors.length).equal(0);
        })

        it("test case 5", function () {
            var query = '{"ssda \\" { }';
            var result = runPreParser(query);
            chai.expect(result.haltingError).to.be.not.null;
            chai.expect(result.haltingError.type).equal("missingCloseQuotes");
            chai.expect(result.haltingError.options.openQuotesCharacter).equal('"');
            chai.expect(result.recoverableErrors.length).equal(0);
        })

        it("test case 6", function () {
            var query = '{"ssda \\';
            var result = runPreParser(query);
            chai.expect(result.haltingError).to.be.not.null;
            chai.expect(result.haltingError.type).equal("missingCloseQuotes");
            chai.expect(result.haltingError.options.openQuotesCharacter).equal('"');
            chai.expect(result.recoverableErrors.length).equal(0);
        })
    });
});
