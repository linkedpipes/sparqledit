import { injectCursor } from './Utils/QueryTerminalInjection';
import { OntologyAutocompleteSubProvider } from "./SubProviders/OntologyAutocompleteSubProvider"
import { IParserResult, ERSParser } from "ERSParser";
import { SparqlLanguageServerSettings } from '../Autocompletition/SparqlLanguageServerSettings';
import { QueryClassInferencer } from '../Autocompletition/Inference/QueryClassInferencer';
import { CleanOntologyClassTextFormatter } from '../Ontology/OntologyClassTextFormatter';
import { ILogger } from '../Logging/Logger';
import { OntologyAssertions } from '../Ontology/OntologyAssertions';

export interface SparqlSignatureHelp {
    label: string;
    documentation: string
}

export class SparqlSignatureHelpProvider {
    private queryClassInferencer: QueryClassInferencer;
    private ontologyClassTextFormatter: CleanOntologyClassTextFormatter = new CleanOntologyClassTextFormatter();

    constructor(
        private logger: ILogger,
        ontologyAssertions: OntologyAssertions) {

        this.queryClassInferencer = new QueryClassInferencer(ontologyAssertions);
    }

    public queryWithCursorParserResult(query: string, cursorOffset: number): IParserResult {
        var query = injectCursor(query, cursorOffset);
        var parser = new ERSParser();
        return parser.parse(query);
    }

    provideSignatureHelp(query: string, cursorOffset: number): SparqlSignatureHelp {
        try {
            var result = this.queryClassInferencer.inferClasses(this.queryWithCursorParserResult(query, cursorOffset).query);
            var cursorContext = result.getVariable("cursor");
        } catch (e) {
            this.logger.log(e);
            return null;
        }

        if (cursorContext == null) {
            return null;
        }

        if (cursorContext.possibleClasses.length == 0) {
            return null;
        }
        var neco = cursorContext.possibleClasses[0].getText()
        return {
            label: cursorContext.possibleClasses.map(x => x.getText(this.ontologyClassTextFormatter)).join(";"),
            documentation: "docs"
        };
    }
}