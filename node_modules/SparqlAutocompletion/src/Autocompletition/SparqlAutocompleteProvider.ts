import { AutocompleteSubProvider } from './SubProviders/AutocompleteSubProvider';
import { OntologyHiearchy } from '../Ontology/OntologyHierchy';
import { OntologyAutocompleteSubProvider } from "./SubProviders/OntologyAutocompleteSubProvider";
import { KeywordAutocompleteSubProvider } from "./SubProviders/KeywordAutocompleteSubProvider";
import { VariableAutocompleteSubProvider } from "./SubProviders/VariableAutocompleteSubProvider";
import { ERSParser } from "ERSParser";
import { AutocompleteContext } from './AutocompleteContext';

import * as _ from "lodash";
import { SparqlLanguageServerSettings } from '../Autocompletition/SparqlLanguageServerSettings';

/**
 * Item kind copied from monaco editor completitionItem. 
 * This enum is copied because monaco editor is otherwise 
 * big and useless dependency.
 */
export enum SparqlAutocompleteItemKind {
    Text = 0,
    Method = 1,
    Function = 2,
    Constructor = 3,
    Field = 4,
    Variable = 5,
    Class = 6,
    Interface = 7,
    Module = 8,
    Property = 9,
    Unit = 10,
    Value = 11,
    Enum = 12,
    Keyword = 13,
    Snippet = 14,
    Color = 15,
    File = 16,
    Reference = 17,
    Folder = 18,
}

export interface SparqlAutocompleteItem {
    label: string,
    kind: SparqlAutocompleteItemKind
    insertText: string;
    filterText?: string
}

export class SparqlAutocompleteProvider {
    private subProviders: AutocompleteSubProvider[];

    constructor(private ontologyHiearchy: OntologyHiearchy, sparqlLanguageServerSettings: SparqlLanguageServerSettings) {
        this.subProviders = [
            new OntologyAutocompleteSubProvider(this.ontologyHiearchy, sparqlLanguageServerSettings),
            new KeywordAutocompleteSubProvider(),
            new VariableAutocompleteSubProvider()];
    }

    provideAutocompleteItems(query: string, cursorOffset: number): SparqlAutocompleteItem[] {
        var context = new AutocompleteContext(query, cursorOffset);
        var autocompleteItems: SparqlAutocompleteItem[][] = [];
        for (var subProvider of this.subProviders) {
            var providerAutocompleteItems = subProvider.provideAutocompleteItems(context);
            autocompleteItems.push(providerAutocompleteItems);
        }

        return _.flatten(autocompleteItems);
    }
}